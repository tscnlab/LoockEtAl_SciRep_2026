bt_w           = slypos_mctq_03_new,     # bedtime on work days
sprep_w        = slypos_mctq_04_new,     # sleep time on work days
slat_w         = slypos_mctq_05,         # sleep onset latency on work days
se_w           = slypos_mctq_06,         # sleep end on work days
si_w           = slypos_mctq_07,         # sleep inertia on work days
# free-day equivalents:
bt_f           = slypos_mctq_10_new,
sprep_f        = slypos_mctq_11_new,     # sleep time
slat_f         = slypos_mctq_12,         # sleep onset latency
se_f           = slypos_mctq_13,         # sleep end
si_f           = slypos_mctq_14,         # sleep inertia
alarm_f        = slypos_mctq_15,         # alarm
# and for pediatric sample:
wd_ped             = slypos_mctq_02_ped,
bt_w_ped           = slypos_mctq_03_ped_new,
sprep_w_ped        = slypos_mctq_04_ped_new,
slat_w_ped         = slypos_mctq_05_ped,
se_w_ped           = slypos_mctq_06_ped,
si_w_ped           = slypos_mctq_07_ped,
# free-day equivalents:
bt_f_ped           = slypos_mctq_10_ped_new,
sprep_f_ped        = slypos_mctq_11_ped_new,
slat_f_ped         = slypos_mctq_12_ped,
se_f_ped           = slypos_mctq_13_ped,
si_f_ped           = slypos_mctq_14_ped,
alarm_f_ped        = slypos_mctq_15_ped,
) %>%
mutate(across(
c(slat_w, slat_w_ped, slat_f, slat_f_ped, se_w, se_w_ped, se_f, se_f_ped, si_w, si_w_ped, si_f, si_f_ped),
as.numeric
)) %>%
# Drop any flagged rows
filter(status != "flag", status_free != "flag_free") %>%
# Parse to hms / durations
mutate(
# pick adult vs child answers
wd      = if_else(group=="Adult", as.integer(wd), as.integer(wd_ped)),
bt_w    = if_else(group=="Adult", hms::parse_hm(as.character(bt_w)), hms::parse_hm(as.character(bt_w_ped))),
sprep_w = if_else(group=="Adult", hms::parse_hm(as.character(sprep_w)), hms::parse_hm(as.character(sprep_w_ped))),
bt_f    = if_else(group=="Adult", hms::parse_hm(as.character(bt_f)), hms::parse_hm(as.character(bt_f_ped))),
sprep_f = if_else(group=="Adult", hms::parse_hm(as.character(sprep_f)), hms::parse_hm(as.character(sprep_f_ped))),
alarm_f = if_else(group=="Adult", as.logical(alarm_f == "1"), as.logical(alarm_f_ped == "1")),
slat_w  = if_else(group=="Adult", slat_w, slat_w_ped),
se_w    = if_else(group=="Adult", se_w, se_w_ped),
si_w    = if_else(group=="Adult", si_w, si_w_ped),
slat_f  = if_else(group=="Adult", slat_f, slat_f_ped),
se_f    = if_else(group=="Adult", se_f, se_f_ped),
si_f    = if_else(group=="Adult", si_f, si_f_ped)
) %>%
# Format conversions
mutate(
slat_w = dminutes(as.numeric(slat_w)), # sleep onset latency
slat_f = dminutes(as.numeric(slat_f)),
se_w   = hms::parse_hm(as.character(se_w)), # sleep end
se_f   = hms::parse_hm(as.character(se_f)),
si_w   = dminutes(as.numeric(si_w)), # sleep inertia
si_f   = dminutes(as.numeric(si_f))
) %>%
# Compute the MCTQ intermediates & msf_sc in one go
mutate(
so_w    = so(sprep_w, slat_w), # sleep onset
so_f    = so(sprep_f, slat_f),
sd_w    = sdu(so_w, se_w),     # sleep duration
sd_f    = sdu(so_f, se_f),
msf     = msl(so_f, sd_f),     # midsleep
sd_week = sd_week(sd_w, sd_f, wd),
msf_sc  = msf_sc(msf, sd_w, sd_f, sd_week, alarm_f) # midsleep corrected
)
rm(list=ls())
graphics.off()
#----- check if pacman is installed - if not install it
if(!require(pacman)) install.packages("pacman")
#----- use pacman function p_load to check all packages that you are using in this script
pacman::p_load(stringr, reshape2, Hmisc, tidyverse, doBy, DescTools,
BayesFactor, effectsize, gtsummary, mctq)
# load data ----------------------------------------------------------------
load(file="./02_data_wrangling/data.rda")
#define functions:
convert_to_decimal_hours <- function(time_string) {
# Split the string into hours and minutes
time_parts <- strsplit(time_string, ":")[[1]]
hours <- as.numeric(time_parts[1])
minutes <- as.numeric(time_parts[2])
# Convert to decimal hours
decimal_hours <- hours + (minutes / 60)
return(decimal_hours)
}
# compute sum scores for questionnaires--------------------------------------
## Photosensitivity Assessment Questionnaire (PAQ)-----------------------------
#create Photophila and Photophobia score values (if NA values--> sum should be NA)
data <- data %>%
mutate(Photophila_score = (slypos_paq_1 + slypos_paq_3 + slypos_paq_4 +
slypos_paq_5 + slypos_paq_8 + slypos_paq_11 +
slypos_paq_15 + slypos_paq_16)/ 8)
data <- data %>%
mutate(Photophobia_score = (slypos_paq_2 + slypos_paq_6 + slypos_paq_7 +
slypos_paq_9 + slypos_paq_10 + slypos_paq_12 +
slypos_paq_13 + slypos_paq_14)/ 8)
#correlation of the two scores for photophobia and photophilia
cor(data$Photophila_score, data$Photophobia_score)
# Compute as one sum score for full paq?
# -- No, decided to not do this and stick to the original interpretation of scores.
## Assessment of Sleep Environment (ASE)----------------------------------------
#recode the answers from 1 - 4 to 0 - 3
data<-data %>%
mutate(slypos_ase_001 = slypos_ase_001 - 1,
slypos_ase_002 = slypos_ase_002 - 1,
slypos_ase_003 = slypos_ase_003 - 1,
slypos_ase_004 = slypos_ase_004 - 1,
slypos_ase_005 = slypos_ase_005 - 1,
slypos_ase_006 = slypos_ase_006 - 1,
slypos_ase_007 = slypos_ase_007 - 1,
slypos_ase_008 = slypos_ase_008 - 1,
slypos_ase_009 = slypos_ase_009 - 1,
slypos_ase_010 = slypos_ase_010 - 1,
slypos_ase_011 = slypos_ase_011 - 1,
slypos_ase_012 = slypos_ase_012 - 1,
slypos_ase_0123 = slypos_ase_0123 - 1)
#create ASE sum score (if NA values --> sum should be NA)
data<-data %>%
mutate(ASE_score =
slypos_ase_001 +
slypos_ase_002 +
slypos_ase_003 +
slypos_ase_004 +
slypos_ase_005 +
slypos_ase_006 +
slypos_ase_007 +
slypos_ase_008 +
slypos_ase_009 +
slypos_ase_010 +
slypos_ase_011 +
slypos_ase_012 +
slypos_ase_0123)
#create levels for ASE sum score:
# score 0 to 9  =  low; 10 to 19 moderate; 20 to 39 = high
# interpretation: high = appropriate sleep environment, low = inappropriate sleeping environment
data <-data %>%
mutate(ASE_levels =    case_when(
ASE_score >= 1 & ASE_score <= 9  ~ "low",
ASE_score >= 10 & ASE_score <= 19  ~ "moderate",
ASE_score >= 20 & ASE_score <= 39  ~ "high"
))
## PROMIS MEASURES - Sum scores ------------------------------------------------
#higher values mean higher impairment and sleep problems
#PROMIS Sleep Disturbance sum score pediatric
# data<-data %>%
#   mutate(Promis_sd_ped_sum=slypos_promis_sd_ped_01 +
#            slypos_promis_sd_ped_02 +
#            slypos_promis_sd_ped_03 +
#            slypos_promis_sd_ped_04)
#
# #PROMIS Sleep Disturbance sum score adult
#
# data<-data %>%
#   mutate(Promis_sd_ad_sum=slypos_promis_sd_ad_01 +
#            slypos_promis_sd_ad_02 +
#            slypos_promis_sd_ad_03 +
#            slypos_promis_sd_ad_04)
#PROMIS Sleep Disturbance sum score for both adults and ped
data <- data %>%
mutate(Promis_sd_sum = rowSums(select(.,
slypos_promis_sd_ped_01,
slypos_promis_sd_ped_02,
slypos_promis_sd_ped_03,
slypos_promis_sd_ped_04,
slypos_promis_sd_ad_01,
slypos_promis_sd_ad_02,
slypos_promis_sd_ad_03,
slypos_promis_sd_ad_04),
na.rm = TRUE))
# #PROMIS Sleep Related Impairment sum score pediatric
# data<-data %>%
#   mutate(Promis_sri_ped_sum=slypos_promis_si_ped_01 +
#            slypos_promis_si_ped_02 +
#            slypos_promis_si_ped_03 +
#            slypos_promis_si_ped_04)
#
# #PROMIS Sleep Related Impairment sum score adult
# data<-data %>%
#   mutate(Promis_sri_ad_sum=slypos_promis_si_ad_01 +
#            slypos_promis_si_ad_02 +
#            slypos_promis_si_ad_03 +
#            slypos_promis_si_ad_04)
#PROMIS Sleep Related Impairment sum score for both adults and ped
data <- data %>%
mutate(Promis_sri_sum = rowSums(select(.,
slypos_promis_si_ped_01,
slypos_promis_si_ped_02,
slypos_promis_si_ped_03,
slypos_promis_si_ped_04,
slypos_promis_si_ad_01,
slypos_promis_si_ad_02,
slypos_promis_si_ad_03,
slypos_promis_si_ad_04),
na.rm = TRUE))
## Self-Administered Rating Scale for Pubertal Development ---------------------
# recode the "I don't know" items (5) and the "prefer not to say" items (6) to NA
data$slypos_puberty_01 <- ifelse(data$slypos_puberty_01 == 5 | data$slypos_puberty_01 == 6, NA, data$slypos_puberty_01)
data$slypos_puberty_02 <- ifelse(data$slypos_puberty_02 == 5 | data$slypos_puberty_02 == 6, NA, data$slypos_puberty_02)
data$slypos_puberty_03 <- ifelse(data$slypos_puberty_03 == 5 | data$slypos_puberty_03 == 6, NA, data$slypos_puberty_03)
data$slypos_puberty_boys_01 <- ifelse(data$slypos_puberty_boys_01 == 5 | data$slypos_puberty_boys_01 == 6, NA, data$slypos_puberty_boys_01)
data$slypos_puberty_boys_02 <- ifelse(data$slypos_puberty_boys_02 == 5 | data$slypos_puberty_boys_02 == 6, NA, data$slypos_puberty_boys_02)
data$slypos_puberty_girl_01 <- ifelse(data$slypos_puberty_girl_01 == 5 | data$slypos_puberty_girl_01 == 6 , NA, data$slypos_puberty_girl_01)
#recode the yes/no question for girls to (no=1) and (yes=4)
#& prefer not to say to NA
data$slypos_puberty_girls_02 <-  ifelse(data$slypos_puberty_girls_02 == 3, NA,
ifelse(data$slypos_puberty_girls_02 == 1, 4,
ifelse(data$slypos_puberty_girls_02 == 2, 1,
data$slypos_puberty_girls_02)))
#Point values are averaged for all items to give a Pubertal Development Scale (PDS) score.
data <- data %>% mutate(
PDS_score_m = rowMeans(
select(., slypos_puberty_01, slypos_puberty_02, slypos_puberty_03, slypos_puberty_boys_01, slypos_puberty_boys_02),
na.rm = FALSE
),
PDS_score_f = rowMeans(
select(., slypos_puberty_01, slypos_puberty_02, slypos_puberty_03, slypos_puberty_girl_01, slypos_puberty_girls_02),
na.rm = FALSE
)
)
#Optional:
#create category score for Puberty scale
#data$slypos_demographics_sex==1 #female
#data$slypos_demographics_sex==2 #male
## MCTQ ------------------------------------------------------------------------
# To do's:
# what to do with the caffeine and food timing items?
#### Sanity check & cleaning --------------------
# i.e., sleep time later than bedtime in mctq (items 3 and 4 entered incorrectly)
# STEP 1: subset and filter to regular work / school schedule only
mctq_checks <- data %>%
select(
record_id,                    #For later merges
slypos_mctq_01.factor,        #"Do you have a regular work schedule?"
slypos_mctq_01_ped.factor,    #"Do you have a regular school schedule?"
contains("mctq"),             #mctq items
-contains("attentioncheck")   #no attention checks
) %>%
# Define flags for irregular schedules
mutate(
slypos_mctq_01.factor = na_if(as.character(slypos_mctq_01.factor), ""), #set empty fields to NA
slypos_mctq_01_ped.factor = na_if(as.character(slypos_mctq_01_ped.factor), "") #set empty fields to NA
) %>%
mutate(
regular = case_when(
slypos_mctq_01.factor == "Yes" ~ TRUE,
slypos_mctq_01_ped.factor == "Yes" ~ TRUE,
TRUE ~ FALSE
)) %>%
# select only regular schedules
filter(regular) %>%
select(-regular) # drop helper column
# STEP 2: fix bed- / sleep times (items 3 / 4)
mctq_checks <- mctq_checks %>%
mutate(across(
c(slypos_mctq_03, slypos_mctq_04,
slypos_mctq_03_ped, slypos_mctq_04_ped,
slypos_mctq_10, slypos_mctq_11,
slypos_mctq_10_ped, slypos_mctq_11_ped),
~ na_if(as.character(.x), "") #set empty fields to NA
)) %>%
mutate(
# raw parse to hms
bed_adult_raw   = hm(slypos_mctq_03),
sleep_adult_raw = hm(slypos_mctq_04),
bed_child_raw   = hm(slypos_mctq_03_ped),
sleep_child_raw = hm(slypos_mctq_04_ped),
# for free days
bed_adult_free_raw   = hm(slypos_mctq_10),
sleep_adult_free_raw = hm(slypos_mctq_11),
bed_child_free_raw   = hm(slypos_mctq_10_ped),
sleep_child_free_raw = hm(slypos_mctq_11_ped),
# time corrections:
# 00:00/12:00 → 24h   (unifying midnight)
# 12:00–12:59 → +12h  (assuming close-to-midnight sleep)
# 06:01–11:59 → +12h  (assuming 12h entry format instead of 24h)
bed_adult = case_when(
slypos_mctq_03  %in% c("00:00","12:00")                    ~ hours(24),
bed_adult_raw  > hm("06:00") & bed_adult_raw  <= hm("11:59") ~ bed_adult_raw + hours(12),
bed_adult_raw  >= hm("12:00") & bed_adult_raw  <  hm("13:00") ~ bed_adult_raw + hours(12),
TRUE                                                         ~ bed_adult_raw
),
sleep_adult = case_when(
slypos_mctq_04  %in% c("00:00","12:00")                    ~ hours(24),
sleep_adult_raw > hm("06:00") & sleep_adult_raw <= hm("11:59")~ sleep_adult_raw + hours(12),
sleep_adult_raw >= hm("12:00") & sleep_adult_raw <  hm("13:00")~ sleep_adult_raw + hours(12),
TRUE                                                         ~ sleep_adult_raw
),
bed_child = case_when(
slypos_mctq_03_ped %in% c("00:00","12:00")                    ~ hours(24),
bed_child_raw  > hm("06:00") & bed_child_raw  <= hm("11:59")   ~ bed_child_raw + hours(12),
bed_child_raw  >= hm("12:00") & bed_child_raw  <  hm("13:00")   ~ bed_child_raw + hours(12),
TRUE                                                           ~ bed_child_raw
),
sleep_child = case_when(
slypos_mctq_04_ped %in% c("00:00","12:00")                    ~ hours(24),
sleep_child_raw > hm("06:00") & sleep_child_raw <= hm("11:59") ~ sleep_child_raw + hours(12),
sleep_child_raw >= hm("12:00") & sleep_child_raw <  hm("13:00") ~ sleep_child_raw + hours(12),
TRUE                                                           ~ sleep_child_raw
),
# for free days
bed_adult_free = case_when(
slypos_mctq_10  %in% c("00:00","12:00")                    ~ hours(24),
bed_adult_free_raw  > hm("06:00") & bed_adult_free_raw  <= hm("11:59") ~ bed_adult_free_raw + hours(12),
bed_adult_free_raw  >= hm("12:00") & bed_adult_free_raw  <  hm("13:00") ~ bed_adult_free_raw + hours(12),
TRUE                                                               ~ bed_adult_free_raw
),
sleep_adult_free = case_when(
slypos_mctq_11  %in% c("00:00","12:00")                    ~ hours(24),
sleep_adult_free_raw > hm("06:00") & sleep_adult_free_raw <= hm("11:59") ~ sleep_adult_free_raw + hours(12),
sleep_adult_free_raw >= hm("12:00") & sleep_adult_free_raw <  hm("13:00") ~ sleep_adult_free_raw + hours(12),
TRUE                                                                    ~ sleep_adult_free_raw
),
bed_child_free = case_when(
slypos_mctq_10_ped %in% c("00:00","12:00")                    ~ hours(24),
bed_child_free_raw  > hm("06:00") & bed_child_free_raw  <= hm("11:59")   ~ bed_child_free_raw + hours(12),
bed_child_free_raw  >= hm("12:00") & bed_child_free_raw  <  hm("13:00")   ~ bed_child_free_raw + hours(12),
TRUE                                                                      ~ bed_child_free_raw
),
sleep_child_free = case_when(
slypos_mctq_11_ped %in% c("00:00","12:00")                    ~ hours(24),
sleep_child_free_raw > hm("06:00") & sleep_child_free_raw <= hm("11:59") ~ sleep_child_free_raw + hours(12),
sleep_child_free_raw >= hm("12:00") & sleep_child_free_raw <  hm("13:00") ~ sleep_child_free_raw + hours(12),
TRUE                                                                      ~ sleep_child_free_raw
),
# coalesce + group tag
bed   = coalesce(bed_adult,   bed_child),
sleep = coalesce(sleep_adult, sleep_child),
bed_free = coalesce(bed_adult_free,   bed_child_free), # free days
sleep_free = coalesce(sleep_adult_free, sleep_child_free),
group = case_when(
slypos_mctq_01.factor == "Yes" ~ "Adult",
slypos_mctq_01_ped.factor == "Yes" ~ "Child",
TRUE ~ NA_character_
)) %>%
# if still inverted but early‐morning, bump sleep +24h (next day shift)
mutate(
sleep = case_when(
sleep < bed & sleep <= hours(6) ~ sleep + hours(24),
TRUE                            ~ sleep
),
sleep_free = case_when(
sleep_free < bed_free & sleep_free <= hours(6) ~ sleep_free + hours(24),
TRUE                                           ~ sleep_free
)
) %>%
select(-ends_with("_raw"))
# STEP 3: tag cases (OK / CORRECTED / FLAG)
mctq_tagged <- mctq_checks %>%
mutate(
inverted = (bed > sleep),
diff = bed - sleep,
status = case_when(
!inverted ~ "ok",
inverted & diff <= hours(1) ~ "corrected",
inverted & diff > hours(1) ~ "flag"
),
inverted_free = (bed_free > sleep_free),
diff_free     = bed_free - sleep_free,
status_free   = case_when(
!inverted_free               ~ "ok_free",
inverted_free & diff_free <= hours(1) ~ "corrected_free",
TRUE                                ~ "flag_free"
)
)
# STEP 4: build a cleaned MCTQ dataset and merge back
mctq_final <- mctq_tagged %>%
mutate(
# swap ≤1h work-day cases
bed_new        = if_else(status == "corrected",            sleep,        bed),
sleep_new      = if_else(status == "corrected",            bed,          sleep),
# swap ≤1h free-day cases
bed_free_new   = if_else(status_free == "corrected_free",  sleep_free,   bed_free),
sleep_free_new = if_else(status_free == "corrected_free",  bed_free,     sleep_free),
# original string swaps for work-day
slypos_mctq_03_new     = case_when(
status == "corrected" ~ slypos_mctq_04,
status == "flag"      ~ NA_character_,
TRUE                    ~ slypos_mctq_03
),
slypos_mctq_04_new     = case_when(
status == "corrected" ~ slypos_mctq_03,
status == "flag"      ~ NA_character_,
TRUE                    ~ slypos_mctq_04
),
slypos_mctq_03_ped_new = case_when(
status == "corrected" ~ slypos_mctq_04_ped,
status == "flag"      ~ NA_character_,
TRUE                    ~ slypos_mctq_03_ped
),
slypos_mctq_04_ped_new = case_when(
status == "corrected" ~ slypos_mctq_03_ped,
status == "flag"      ~ NA_character_,
TRUE                    ~ slypos_mctq_04_ped
),
# original string swaps for free-day
slypos_mctq_10_new     = case_when(
status_free == "corrected_free" ~ slypos_mctq_11,
status_free == "flag_free"      ~ NA_character_,
TRUE                              ~ slypos_mctq_10
),
slypos_mctq_11_new     = case_when(
status_free == "corrected_free" ~ slypos_mctq_10,
status_free == "flag_free"      ~ NA_character_,
TRUE                              ~ slypos_mctq_11
),
slypos_mctq_10_ped_new = case_when(
status_free == "corrected_free" ~ slypos_mctq_11_ped,
status_free == "flag_free"      ~ NA_character_,
TRUE                              ~ slypos_mctq_10_ped
),
slypos_mctq_11_ped_new = case_when(
status_free == "corrected_free" ~ slypos_mctq_10_ped,
status_free == "flag_free"      ~ NA_character_,
TRUE                              ~ slypos_mctq_11_ped
)
) %>%
select(
record_id, group, status, status_free,
bed_new,  sleep_new,    bed_free_new,  sleep_free_new,
slypos_mctq_03_new, slypos_mctq_04_new,
slypos_mctq_03_ped_new, slypos_mctq_04_ped_new,
slypos_mctq_10_new, slypos_mctq_11_new,
slypos_mctq_10_ped_new, slypos_mctq_11_ped_new
)
# merge back onto `data` by record_id:
data <- data %>%
left_join(
mctq_final,
by = "record_id"
)
# Compute MSFsc for analysis ------------------------------------
msf <- data %>%
# Select columns needed for MSFsc (keeping record_id, group, status)
select(
record_id, status, status_free, group,
wd             = slypos_mctq_02,         # work days
bt_w           = slypos_mctq_03_new,     # bedtime on work days
sprep_w        = slypos_mctq_04_new,     # sleep time on work days
slat_w         = slypos_mctq_05,         # sleep onset latency on work days
se_w           = slypos_mctq_06,         # sleep end on work days
si_w           = slypos_mctq_07,         # sleep inertia on work days
# free-day equivalents:
bt_f           = slypos_mctq_10_new,
sprep_f        = slypos_mctq_11_new,     # sleep time
slat_f         = slypos_mctq_12,         # sleep onset latency
se_f           = slypos_mctq_13,         # sleep end
si_f           = slypos_mctq_14,         # sleep inertia
alarm_f        = slypos_mctq_15,         # alarm
# and for pediatric sample:
wd_ped             = slypos_mctq_02_ped,
bt_w_ped           = slypos_mctq_03_ped_new,
sprep_w_ped        = slypos_mctq_04_ped_new,
slat_w_ped         = slypos_mctq_05_ped,
se_w_ped           = slypos_mctq_06_ped,
si_w_ped           = slypos_mctq_07_ped,
# free-day equivalents:
bt_f_ped           = slypos_mctq_10_ped_new,
sprep_f_ped        = slypos_mctq_11_ped_new,
slat_f_ped         = slypos_mctq_12_ped,
se_f_ped           = slypos_mctq_13_ped,
si_f_ped           = slypos_mctq_14_ped,
alarm_f_ped        = slypos_mctq_15_ped,
) %>%
mutate(across(
c(slat_w, slat_w_ped, slat_f, slat_f_ped, si_w, si_w_ped, si_f, si_f_ped),
as.numeric
)) %>%
# Drop any flagged rows
filter(status != "flag", status_free != "flag_free") %>%
# Parse to hms / durations
mutate(
# pick adult vs child answers
wd      = if_else(group=="Adult", as.integer(wd), as.integer(wd_ped)),
bt_w    = if_else(group=="Adult", hms::parse_hm(as.character(bt_w)), hms::parse_hm(as.character(bt_w_ped))),
sprep_w = if_else(group=="Adult", hms::parse_hm(as.character(sprep_w)), hms::parse_hm(as.character(sprep_w_ped))),
bt_f    = if_else(group=="Adult", hms::parse_hm(as.character(bt_f)), hms::parse_hm(as.character(bt_f_ped))),
sprep_f = if_else(group=="Adult", hms::parse_hm(as.character(sprep_f)), hms::parse_hm(as.character(sprep_f_ped))),
alarm_f = if_else(group=="Adult", as.logical(alarm_f == "1"), as.logical(alarm_f_ped == "1")),
slat_w  = if_else(group=="Adult", slat_w, slat_w_ped),
se_w    = if_else(group=="Adult", se_w, se_w_ped),
si_w    = if_else(group=="Adult", si_w, si_w_ped),
slat_f  = if_else(group=="Adult", slat_f, slat_f_ped),
se_f    = if_else(group=="Adult", se_f, se_f_ped),
si_f    = if_else(group=="Adult", si_f, si_f_ped)
) %>%
# Format conversions
mutate(
slat_w = dminutes(as.numeric(slat_w)), # sleep onset latency
slat_f = dminutes(as.numeric(slat_f)),
se_w   = hms::parse_hm(as.character(se_w)), # sleep end
se_f   = hms::parse_hm(as.character(se_f)),
si_w   = dminutes(as.numeric(si_w)), # sleep inertia
si_f   = dminutes(as.numeric(si_f))
) %>%
# Compute the MCTQ intermediates & msf_sc in one go
mutate(
so_w    = so(sprep_w, slat_w), # sleep onset
so_f    = so(sprep_f, slat_f),
sd_w    = sdu(so_w, se_w),     # sleep duration
sd_f    = sdu(so_f, se_f),
msf     = msl(so_f, sd_f),     # midsleep
sd_week = sd_week(sd_w, sd_f, wd),
msf_sc  = msf_sc(msf, sd_w, sd_f, sd_week, alarm_f) # midsleep corrected
)
View(msf[1:3, ])
data <- data %>%
left_join(
msf %>% select(record_id, msf_sc), # only MSFsc selected for now
by = "record_id"
)
